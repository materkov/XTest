XTest
=====
Проект (тестовое задание) представляет собой приложение на базе PHP-фреймворка Symfony3.

Все обязательные требования выполнена, плюс примерно половина из списка дополнительных.

## Документация
Документация по методам расположена в [здесь](https://materkov.com/docs).

Спецификация написана на RAML: [docs/api.raml](docs/api.raml). Из нее сгенерирована
API-консоль на базе https://github.com/mulesoft/api-console

## Описание архитектуры подобного API, работающего с большой нагрузкой

Если есть возможность хранить файлы не локально, а использовать что-то вроде
Amazon S3, я бы хранил там. Возникает вопрос с метаданными, какие именно данные нужны?
Если нужен только размер/дату создания, то API позволяет это сделать.

Если передача и запись файлов идут на S3, то лучше подойдут
платформы, которые предлагают асинхронное неблокирующее I/O
(NodeJS, Tornado и т.д.).

Единственное, что остается в PHP-компоненте - это авторизация. Можно перенести ее
туда же, и тогда приложение на PHP будет не нужно вовсе. Либо можно оставить PHP-часть
и перенаправлять запрос средствами Nginx через X-Accel-Redirect на следующий апстрим.

Если файлы все-таки хранятся локально, тогда можно оптимизировать метод отдачи файлов.
В приложении только проверить авторизацию, а отдавать файл через X-Accel-Redirect 
средствами nginx.


## Хронология разработки
### 14.09.2016

Создал приложение на симфони. Пока что обойдемся без авторизации. Создадим первый метод, который
показывает список файлов. Он должен быть тестируемым. Нужно будет мокать файловую систему.
Нужно чтобы контроллер был абстрагирован от операций с ФС.

Поэтому создадим сервис FileManager. Добавим в него метод listDir (вместе с юнит-тестом).

ОК, теперь создадим метод, возвращающий список файлов и использующий этот сервис
(вместе с функциональным тестом). Неплохое начало.

Теперь про авторизацию. Добавим сущность User (из FOSUserBundle).

ОК. Теперь есть HTTP Basic Auth, все адреса защищены. На всякий случай 
запишу здесь: user - pass 

Разберемся с метаданными файла. Добавим в FileManager getMeta.
Будем использовать встроенную функцию finfo_file. Одновременно тестик. Все ОК.

Во время написания теста, обнаруживается, что предыдущие поломались,
т.к. авторизация доабвилась. Нужно разобраться с фикстурами чтобы создать
фейкового пользователя перед запуском тестов.

### 15.09.2016
Разобрался с фикстурами (фейковыми данными для тестов).

Если файл отсутствует, возвращается 404.

Добавил возврат содержимого файла, добавил корректные заголовки Content-Type (тесты
тоже обновил).

Добавил метод создания файла (вместе с добавлением новых методов в сервис и вместе с
тестами).


### 16.09.2016
Ронял что отдельный метод POST /files получается, его можно заменить
на PUT /file/{name}. Почитал стандарт - он позволяет делать такое 
(в случае если файла нет создавать и отвечать 201, в случае если есть - 
обновлять и отвечать 200). Решил метод POST убрать, однако тут возникла загвоздка...
Файлы в PHP принимаются только если тип запроса - POST.

Решил это тем, что создал второй контроллер и запилиил метод там.
Изменился менеджер, теперь он читает из php://input и сохраняет сразу же
в файл. Тестики прилагаются. Ан нет, этот php://input нетестируемый получился.
Использую встроенный метод getContent(). Теперь порядок.

ОК. Теперь тесты мне нравятся совсем. Полностью их переосмыслилю. Разделил на две папочки
Unit и Functional, из функциональных выкинул моки (моки ведь только для юнит тестов, чего это я).

Вот, теперь базовый функционал полностью готов. Радуемся и пляшем.

## 17...18.09.2016
Разбирался с докером, все приложение развернуто внутри одного контейнера в докере.

## 19.09.2016
Сделал документацию в формате RAML. (docs/api.raml). Сгенерировал веб-версию на основе описания:
https://materkov.com/docs Там можно немного поиграться прямо со страницы (логин user пароль pass).


